<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo de Consumo de Energia</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Calculadora de Consumo de Energia</h1>
        <form id="calculoForm">
            <div class="form-group">
                <label for="unidadeConsumidoraSelect">Unidade Consumidora</label>
                <select id="unidadeConsumidoraSelect" class="form-control">
                    <option value="">Selecione</option>
                    <!-- As opções serão preenchidas pelo JavaScript -->
                </select>
            </div>

            <div class="form-group">
                <label for="dependenciaSelect">Dependências (Opcional)</label>
                <select id="dependenciaSelect" class="form-control">
                    <option value="">Selecionar Dependência</option>
                    <!-- As opções serão preenchidas pelo JavaScript -->
                </select>
            </div>

            <div class="form-group">
                <label for="bandeiraSelect">Bandeiras</label>
                <select id="bandeiraSelect" class="form-control">
                    <!-- As opções serão preenchidas pelo JavaScript -->
                </select>
            </div>

            <div class="form-group">
                <label for="tipoConsumidorSelect">Tipos de Consumidores</label>
                <select id="tipoConsumidorSelect" class="form-control">
                    <!-- As opções serão preenchidas pelo JavaScript -->
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Calcular Consumo</button>
        </form>

        <div id="resultado" class="mt-4">
            <!-- O resultado será exibido aqui -->
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Funções para preencher selects com dados do backend
            fetchOptions('unidades-consumidoras', 'unidadeConsumidoraSelect');
            fetchOptions('dependencias', 'dependenciaSelect');
            fetchOptions('bandeiras', 'bandeiraSelect');
            fetchOptions('tipos-consumidores', 'tipoConsumidorSelect');

            // Evento para calcular o consumo
            document.getElementById('calculoForm').addEventListener('submit', function (event) {
                event.preventDefault();
                calcularConsumo();
            });
        });

        function fetchOptions(endpoint, selectId) {
            fetch(`http://localhost:8000/${endpoint}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById(selectId);
                    if (data && data.length) {
                        select.innerHTML = '<option value="">Selecione</option>';
                        data.forEach(item => {
                            select.innerHTML += `<option value="${item.id}">${item.nome}</option>`;
                        });
                    } else {
                        select.innerHTML = '<option value="">Nenhum item encontrado.</option>';
                    }
                })
                .catch(error => {
                    console.error(`Erro ao buscar ${endpoint}:`, error);
                });
        }

        function calcularConsumo() {
            const unidadeConsumidoraId = document.getElementById('unidadeConsumidoraSelect').value;
            const dependenciaId = document.getElementById('dependenciaSelect').value;
            const bandeiraId = document.getElementById('bandeiraSelect').value;
            const tipoConsumidorId = document.getElementById('tipoConsumidorSelect').value;

            if (!unidadeConsumidoraId) {
                alert('Por favor, selecione uma unidade consumidora.');
                return;
            }

            const url = `http://localhost:8000/consumos?origem_do_consumo=residencia&item_id=${unidadeConsumidoraId}`;
            if (dependenciaId) {
                url += `&dependencia=${dependenciaId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const consumoDiario = data.consumo_diario || 0;
                    const consumoMensal = data.consumo_mensal || 0;
                    const consumoAnual = data.consumo_anual || 0;

                    document.getElementById('resultado').innerHTML = `
                        <h3>Resultado</h3>
                        <p>Consumo Diário: ${consumoDiario} kWh</p>
                        <p>Consumo Mensal: ${consumoMensal} kWh</p>
                        <p>Consumo Anual: ${consumoAnual} kWh</p>
                    `;
                })
                .catch(error => {
                    console.error('Erro ao calcular consumo:', error);
                });
        }
    </script>
</body>
</html>
